package net.seesharpsoft.spring.suite.boot;

import net.seesharpsoft.spring.data.domain.SelectableRepository;
import net.seesharpsoft.spring.data.domain.impl.SelectableRepositoryImpl;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
import org.springframework.beans.factory.support.BeanDefinitionRegistry;
import org.springframework.beans.factory.support.BeanDefinitionRegistryPostProcessor;
import org.springframework.core.env.Environment;
import org.springframework.util.Assert;

public class SharpingRegistryPostProcessor implements BeanDefinitionRegistryPostProcessor {

    protected final Environment environment;

    public SharpingRegistryPostProcessor(Environment environment) {
        Assert.notNull(environment, "environment must not be null!");
        this.environment = environment;
    }

    protected Class<? extends  SelectableRepository> getSelectableRepositoryImplementation() {
        try {
            return (Class<? extends SelectableRepository>)Class.forName(environment.getProperty(ConfigurationProperties.SELECTABLE_IMPL_CLASS, SelectableRepositoryImpl.class.getName()));
        } catch (ClassNotFoundException exc) {
            throw new RuntimeException(exc);
        }
    }

    protected String[] getSelectableBasePackages() {
        String basePackages = environment.getProperty(ConfigurationProperties.SELECTABLE_BASE_PACKAGES);
        if (basePackages == null) {
            return new String[0];
        }
        return basePackages.split(";");
    }

    @Override
    public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanDefinitionRegistry) throws BeansException {
        SelectableInterfaceScanRegistrar.registerSelectableRepositoryDefinitions(beanDefinitionRegistry, environment, getSelectableRepositoryImplementation(), getSelectableBasePackages());
    }

    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory configurableListableBeanFactory) throws BeansException {

    }
}
